#
# Assumes you have a fresh installation of Ubuntu server
#

# Create user - logged on as root
adduser roberto
# add to group sudo
usermod -aG sudo roberto

#logout and re-login as "roberto"
# prevent sudo from propting
sudo visudo
# then change  "%sudo ALL=(ALL) ALL" => "%sudo ALL=(ALL) NOPASSWD:ALL
# create installs and websites folders
mkdir installs
mkdir websites
mkdir websites/SmartEnergyLabDataApi
mkdir websites/SmartEnergyLabGui

# set up locale to uk
sudo localectl set-locale LANG=en_GB.utf8
# if en_GB not installed then generate it with
sudo locale-gen en_GB.utf8
# timezone
sudo timedatectl set-timezone Europe/London

# install postgres
sudo apt install postgresql postgresql-contrib
# creates a super user
sudo -u postgres createuser --superuser rob
# change password
sudo -u postgres psql
ALTER USER rob WITH PASSWORD 'speedy';
CREATE USER smart_energy_lab;
ALTER USER smart_energy_lab PASSWORD '1234567890';
CREATE DATABASE smart_energy_lab WITH OWNER = smart_energy_lab;
\q
#
# Should be able to connect to smart_energy_lab using beaverdb ...
#
# to move smart_energy_lab db to new location ..
# on the current server dump db with
pg_dump smart_energy_lab > smart_energy_lab.sql
# then restore with 
psql -h <ip_address/hostname> -U smart_energy_lab < smart_energy_lab.sql

# Install .net framework
# (more info here https://docs.microsoft.com/en-us/dotnet/core/install/linux-ubuntu)
sudo apt-get update; \
  sudo apt-get install -y apt-transport-https && \
  sudo apt-get update && \
  sudo apt-get install -y dotnet-sdk-6.0
# should appear on list of runtime
dotnet --list-runtimes

#
# install Nginx
#
# more info https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-2.1&tabs=aspnetcore2x
sudo apt install nginx
sudo nano /etc/nginx/sites-available/lv-data.net-zero-energy-systems.org                            # use one from "Server config files"
sudo ln -s /etc/nginx/sites-available/lv-data.net-zero-energy-systems.org /etc/nginx/sites-enabled/ # add symbolic link 
sudo rm /etc/nginx/sites-available/default                                                          # remove default behaviour
sudo nginx -t                                                                                       # to test configuration
sudo nginx -s reload                                                                                # to reload config


#
# GO BACK to  development machine
#
# use private key instead of password
ssh-copy-id roberto@<ip address or hostname>

#
# sFtp autoInstall.sh,SmartEnergyLabDataApi.service to home directory
#

#
# Configure services with port to list on and urls to serve
# and move to system location
sudo mv SmartEnergyLabDataApi.service /etc/systemd/system
# enable service
sudo systemctl enable SmartEnergyLabDataApi.service

# install unzip
sudo apt install unzip

# edit BuildAndPublishProduction.sh to point to new server then run it
bash BuildAndPublishProduction.sh

#
# Should work on http://lv-data.net-zero-energy-systems.org now!
#
# GO BACK to server and install certbot
sudo snap install --classic certbot
# run certbot to add support for https:
sudo certbot --nginx -d lv-data.net-zero-energy-systems.org
# test with https://lv-data.net-zero-energy-systems.org!

#
# install gdal
#
# download anaconda from https://www.anaconda.com
wget https://repo.anaconda.com/archive/Anaconda3-2023.03-1-Linux-x86_64.sh
bash Anaconda3-2023.03-1-Linux-x86_64.sh
# then restart terminal and ...
conda install gdal
# then run this to check it works
ogr2ogr
# add symbolic link to websites install dir
cd websites/SmartEnergyLabDataApi
ln -s /home/rob/anaconda3/bin/ogr2ogr .

#
# install smtp server - also installs postfix which is what we want
#
# see also https://hostadvice.com/how-to/how-to-setup-postfix-as-send-only-mail-server-on-an-ubuntu-18-04-dedicated-server-or-vps/
sudo apt install mailutils
# will start a gui - enter "internet site"
# and "net-zero-energy-systems.org" as domain
# now configure postfix
sudo nano /etc/postfix/main.cf
# make it only respond locally by ensuring "inet_interfaces = loopback-only" is set

# restart postfix (could use sudo systemctl restart postfix?)
sudo service postfix restart
# Look in these places for errors
# sudo cat /var/log/mail.log
# sudo cat /var/log/mail.err
# postqueue -p

#
#unattended upgrades
# upgrade cycle gets run 06-07am (via systemd time /lib/systemd/system/apt-daily-upgrade.timer)
sudo apt install unattended-upgrades
sudo nano /etc/apt/apt.conf.d/50unattended-upgrades
# make these changes to the file:-
# Unattended-Upgrade::Mail "roldaker@gmail.com";
# Unattended-Upgrade::Automatic-Reboot "true";
# Unattended-Upgrade::Automatic-Reboot-Time "02:00";
sudo nano /etc/apt/apt.conf.d/20auto-upgrades
# APT::Periodic::AutocleanInterval "7";

# add crontab enry to backup db daily
crontab -e
# add
MAILTO=roldaker@gmail.com
#
00 04 * * * curl --fail --no-progress-meter http://localhost:5020/Admin/BackupDb > /dev/null
00 05 * * * curl --fail --no-progress-meter --request POST http://localhost:5020/Elexon/ImportGspDemandProfiles > /dev/null
# Monitor dotnet installs and restart services if an update detected
# unattended upgrades runs 6.30ish so scheduled for 8 to ensure its finished
# only redirect stdout so that stderr gets emailed
00 08 * * * cd websites && AutoRestartDotNetServices > /dev/null







