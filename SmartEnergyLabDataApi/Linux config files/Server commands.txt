#
# Assumes you have a fresh installation of Ubuntu server
#

# Create user - logged on as root
adduser roberto
# add to group sudo
usermod -aG sudo roberto

#logout and re-login as "roberto"
# prevent sudo from propting
sudo visudo
# then change  "%sudo ALL=(ALL) ALL" => "%sudo ALL=(ALL) NOPASSWD:ALL
# create installs and websites folders
mkdir installs
mkdir websites
mkdir websites/SmartEnergyLabDataApi
mkdir websites/SmartEnergyLabGui

# set up locale to uk
sudo localectl set-locale LANG=en_GB.utf8
# if en_GB not installed then generate it with
sudo locale-gen en_GB.utf8
# timezone
sudo timedatectl set-timezone Europe/London

# install postgres
sudo apt install postgresql postgresql-contrib
# creates a supoer user
sudo -u postgres
createuser --superuser rob
# change password
psql
ALTER USER rob WITH PASSWORD 'speedy';
CREATE USER smart_energy_lab;
ALTER USER smart_energy_lab PASSWORD '1234567890';
CREATE DATABASE smart_energy_lab WITH OWNER = smart_energy_lab;
\q
#
# Should be able to connect to smart_energy_lab using beaverdb ...
#
# to move smart_energy_lab db to new location ..
# on the current server dump db with
pg_dump smart_energy_lab > smart_energy_lab.sql
# then restore with 
psql -h <ip_address/hostname> -U smart_energy_lab < smart_energy_lab.sql

# Install .net framework
# (more info here https://docs.microsoft.com/en-us/dotnet/core/install/linux-ubuntu)
sudo apt-get update; \
  sudo apt-get install -y apt-transport-https && \
  sudo apt-get update && \
  sudo apt-get install -y dotnet-sdk-6.0
# should appear on list of runtime
dotnet --list-runtimes

#
# install Nginx
#
# more info https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-2.1&tabs=aspnetcore2x
sudo apt install nginx
sudo nano /etc/nginx/sites-available/lv-data.net-zero-energy-systems.org                            # use one from "Server config files"
sudo ln -s /etc/nginx/sites-available/lv-data.net-zero-energy-systems.org /etc/nginx/sites-enabled/ # add symbolic link 
sudo rm /etc/nginx/sites-available/default                                                          # remove default behaviour
sudo nginx -t                                                                                       # to test configuration
sudo nginx -s reload                                                                                # to reload config


#
# GO BACK to  development machine
#
# use private key instead of password
ssh-copy-id roberto@<ip address or hostname>

#
# sFtp autoInstall.sh,SmartEnergyLabDataApi.service to home directory
#

#
# Configure services with port to list on and urls to serve
# and move to system location
sudo mv SmartEnergyLabDataApi.service /etc/systemd/system
# enable service
sudo systemctl enable SmartEnergyLabDataApi.service

# install unzip
sudo apt install unzip

# edit BuildAndPublishProduction.sh to point to new server then run it
bash BuildAndPublishProduction.sh

#
# Should work on http://lv-data.net-zero-energy-systems.org now!
#
# GO BACK to server and install certbot
sudo snap install --classic certbot
# run certbot to add support for https:
sudo certbot --nginx -d lv-data.net-zero-energy-systems.org
# test with https://lv-data.net-zero-energy-systems.org!


#
# install gdal
#
# download anaconda from https://repo.anaconda.com
bash Anaconda3-2023.03-Linux-x86_64.sh
# then restart terminal and ...
conda install gdal
# then run this to check it works
ogr2ogr





